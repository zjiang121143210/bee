/*!
 * Bee 数据采集SDK
 * Version 0.0.1
 * https://github.com/zjiang121143210/bee
 * wx: zjiang1_12 欢迎联系
*/
!function(){"use strict";function o(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e){return function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var l={v:"0.0.1",prefix:"bee_",cid:"",req:"clew.fun/log",session_time:18e5,user_time:94608e6,uidNum:20,debug:!0,domain:null,autoPage:!0,spa:!1,clickTag:"data-bee",allClick:!1,clickList:["a","button","svg","img"],imp:!1,impTag:"data-bee",impInterval:4e3,event:{page:"page",click:"click",imp:"imp",cstm:"event"}},t=Object.prototype.toString,u=window,n=window.document,d=u.location,a=u.console,s=u.navigator,c=s.userAgent,f={isUndefined:function(e){return void 0===e},isVoid:function(e){return null==e||""===e},isNull:function(e){return null===e},isNotVoid:function(e){return!f.isVoid(e)},isDef:function(e){return null!=e},isString:function(e){return"[object String]"===t.call(e)},isObject:function(e){return"[object Object]"===t.call(e)},isFunction:function(e){return"[object Function]"===t.call(e)}};f.isArray=Array.isArray||function(e){return"[object Array]"===t.call(e)};var i=Object.prototype.hasOwnProperty;f.hasOwn=function(e,t){return i.call(e,t)},f.joinJson=function(e){if(f.isUndefined(e))return{};for(var t=arguments.length,i=Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return Object.assign.apply(Object,[e].concat(i))},f.updateFormJson=function(i){for(var e=arguments.length,t=Array(1<e?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];return t.forEach(function(t){f.isObject(t)&&Reflect.ownKeys(t).forEach(function(e){f.hasOwn(i,e)&&(i[e]=t[e])})}),i},f.checkRCFL=function(e){var t=e,i="_ENTER_";return Reflect.ownKeys(t).forEach(function(e){f.isString(t[e])&&(t[e]=t[e].replace(/\\n\\r/g,i).replace(/\\r\\n/g,i).replace(/\\r/g,i).replace(/\\n/g,i).replace(/\t/g," ").replace(/\r/g," ").replace(/\n/g," "))}),t},f.getTopDomain=function(e){var t=e.lastIndexOf(".");if(-1==t)return e;var i=e.substring(0,t).lastIndexOf(".");if(-1<i){var n=e.substring(i);if(".com.cn"!=n)return n;var o=e.substring(0,i).lastIndexOf(".");return-1<o?e.substring(o):".".concat(e)}return".".concat(e)},f.setCookie=function(e,t,i){var n=arguments.length<=3||void 0===arguments[3]||arguments[3],o=new Date,r=n?l.prefix:"";o.setTime(o.getTime()+i);var a="".concat(r).concat(e,"=").concat(encodeURI(t),";expires=").concat(o.toUTCString(),";path=/;domain=").concat(l.domain);return document.cookie=a,t},f.getCookie=function(e){var t,i=RegExp("(^| )".concat(arguments.length<=1||void 0===arguments[1]||arguments[1]?l.prefix:"").concat(e,"=([^;]*)(;|$)"));return(t=document.cookie.match(i))?unescape(t[2]):null},f.updateCookieDate=function(e,t){var i=arguments.length<=2||void 0===arguments[2]||arguments[2];f.setCookie(e,f.getCookie(e,i),t,i)},f.addListener=function(e,t,i){document.all?window.attachEvent("on".concat(e),t):window.addEventListener(e,t,i)},f.getAttribute=function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=e.getAttribute(t)?e.getAttribute(t):"";!n&&i&&(e=e.parentNode)&&"BODY"!==e.nodeName&&"HTML"!==e.nodeName&&"#document"!==e.nodeName;)n=e.getAttribute(t)?e.getAttribute(t):"";return n},f.getElementInfo=function(e){var t=e.getAttribute("href")||e.getAttribute("src")||"",i=e.innerText||"",n=f.getElementIndex(e);return{ev:i,ex:f.getElementPath(e),ei:n,eh:t}},f.getElementIndex=function(e){var t=1,i=e.parentNode.childNodes;if(!i||0===i.length)return t;for(var n=0,o=i.length;n<o;n+=1)if(i[n]===e){t=n+1;break}return t},f.getElementPath=function(e){if(!e||e===document.body)return"";var t=e.id?"#".concat(e.id):"",i=e.className?".".concat(e.className):"",n="/".concat(e.tagName.toLowerCase()).concat(t).concat(i);return f.getElementPath(e.parentNode)+n},f.isHrefChange=function(e,t){return!(!t||"string"!=typeof t||t===e)&&(e=e.replace(/\?.*$/,"").replace(/#.*$/,""))!==t.replace(/\?.*$/,"").replace(/#.*$/,"")},f.customEvent=function(e,t){var i=null;u.CustomEvent?i=new CustomEvent(e,{detail:t}):((i=n.createEvent("HTMLEvents")).initEvent(e,!1,!0),i.detail=t),u.dispatchEvent(i)},f.customHistory=function(e){var s=this,c=u.history[e];"function"==typeof c&&(u.history[e]=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[2];if(!n)return!1;var o=d.href;/^((http|https):)?\/\//.test(n)||(n=s.getLocationOrigin()+(n.indexOf("/")?"/".concat(n):n));var r=s.hrefIsChange(o,n),a=c.apply(u.history,t);return r&&s.customEvent("beeHistoryChange",{oldURL:o,newURL:n}),a},u.history[e].toString="Bee custom: ".concat(e,"() { [native code] }"))},f.validUid=function(e){if(f.isVoid(e))return!1;var t=e.split("-");return 2===t.length&&t[1].length===l.uidNum},f.createId=function(e){for(var t="";t.length<e;)t+=Math.random().toString(36).substr(2);return"".concat((new Date).getTime().toString(36),"-").concat(t.substr(0,e)).toLocaleUpperCase()},f.getPlatform=function(){var e=/(win|android|linux|nokia|ipad|iphone|ipod|mac|sunos|solaris)/.exec(s.platform.toLowerCase()),t="";if(f.isVoid(e))t="other";else if("linux"===e[0]){var i=/(android)/.exec(c.toLowerCase());t=f.isNull(i)?e[0]:"android"}else t=e[0];return t},f.analysisUA=function(){var i={name:"other",version:"0"},n=c.toLowerCase(),o={miniprogram:/miniprogram/,weixin:/micromessenger[|\/]([\w.]+)/,se360:/360se/,se360_2x:/qihu/,ie:/msie[ ]([\w.]+)/,firefox:/firefox[|\/]([\w.]+)/,chrome:/chrome[|\/]([\w.]+)/,safari:/version[|\/]([\w.]+)(\s\w.+)?\s?safari/,opera:/opera[|\/]([\w.]+)/};return Reflect.ownKeys(o).forEach(function(e){var t=o[e].exec(n);t&&(i.name=e,i.version=t[1]||"0")}),i},f.isM=function(){return/(iPhone|iPad|iPod|iOS|ios|Android|Mobile)/i.test(c)};var p=function(){l.debug&&!f.isUndefined(a)&&a&&a.log.apply(a,arguments)},g=function(){if(!f.isUndefined(a)&&a){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=["Bee error:"].concat(t);a.error.apply(a,r(n))}},h=window,m=h.screen,v=h.document,b=h.navigator;function C(){this.setPtm(),f.isVoid(l.cid)&&(C.prototype.getCid=function(){return""}),this.browser=function(){var e={};e.bi="".concat(h.innerWidth||"-","x").concat(h.innerHeight||"-"),e.sr=m?"".concat(m.width||"-","x").concat(m.height||"-"):"-x-",e.bl=b&&b.language?b.language:"-",e.so=f.getPlatform();var t=f.analysisUA();return e.bt=t.name,e.bv=t.version,e}(),this.url=v.URL,this.domain=v.domain,this.rf=v.referrer,this.ua=navigator&&navigator.userAgent?navigator.userAgent:"-"}C.prototype._makeCommonData=function(e){f.isVoid(f.getCookie("sid"))&&this.setSessionData();var t={u:f.getCookie("uid"),s:f.getCookie("sid"),c:this.getCid(),p:l.pid,t:e,sdk:l.v,tm:e===l.event.page?this.ptm:"".concat((new Date).getTime()),fs:f.getCookie("fs"),ls:f.getCookie("ls"),ts:f.getCookie("ts"),vs:f.getCookie("sq"),bt:this.browser.bt,bv:this.browser.bv,so:this.browser.so,sr:this.browser.sr,bi:this.browser.bi,bl:this.browser.bl,d:this.domain,url:this.url,rf:this.rf};return e!==l.event.visit&&e!==l.event.page&&(t.ptm=this.ptm),t},C.prototype.makePageData=function(){var e;return e=this._makeCommonData(l.event.page),f.joinJson(e,{tl:v.title||""})},C.prototype.makeClickData=function(e,t){var i,n=e.ev,o=e.ex,r=e.ei,a=e.eh;return i=this._makeCommonData(l.event.click),f.joinJson(i,{br:t,ev:n,ex:o,ei:r,eh:a})},C.prototype.makeImpData=function(e){var o=[];e.forEach(function(e){var t,i,n=(i={br:"",ev:"",ex:"",ei:0,eh:""},(t=e)instanceof HTMLElement?(i=f.getElementInfo(t)).br=f.getAttribute(t,l.impTag,!1):f.isString(t)?i.br=t:t instanceof Object&&(i=f.updateFormJson(i,t)),i);o.push(n)});var t=this._makeCommonData(l.event.imp);return t.imp=o,t},C.prototype.makeCustomData=function(e,t){var i=f.isString(t)?t:JSON.stringify(t),n=this._makeCommonData(l.event.cstm);return n.et=e,n.ep=i,n},C.prototype.updateRoute=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:v.URL,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:v.referrer;this.setPtm(),this.url=e,this.rf=t},C.prototype.setPtm=function(){this.ptm="".concat((new Date).getTime())},C.prototype.setUserData=function(){this.clearCookie(),this.setUid(),this.setFs()},C.prototype.setUid=function(){return f.setCookie("uid",f.createId(l.uidNum),l.user_time)},C.prototype.setFs=function(){f.setCookie("fs",this.ptm,l.user_time),f.setCookie("ls","-",l.user_time)},C.prototype.setSessionData=function(){this.setSt(),this.setSq(),this.setSid()},C.prototype.setSt=function(){var e=f.getCookie("ts")||f.getCookie("fs")||0;f.setCookie("ls",e,l.user_time),f.setCookie("ts",this.ptm,l.user_time)},C.prototype.setSq=function(){var e=f.getCookie("sq");return e=f.isNotVoid(e)?parseInt(e,10)+1:1,f.setCookie("sq",e,l.user_time),e},C.prototype.setSid=function(){return f.setCookie("sid","".concat(f.getCookie("uid"),"-").concat(f.getCookie("sq")),l.session_time)},C.prototype.getCid=function(){return f.getCookie(l.cid,!1)},C.prototype.updateCookieDate=function(){f.updateCookieDate("sid",l.session_time),f.updateCookieDate("uid",l.user_time),f.updateCookieDate("sq",l.user_time),f.updateCookieDate("fs",l.user_time),f.updateCookieDate("ls",l.user_time),f.updateCookieDate("ts",l.user_time)},C.prototype.clearCookie=function(){f.updateCookieDate("sid",0),f.updateCookieDate("uid",0),f.updateCookieDate("sq",0),f.updateCookieDate("fs",0),f.updateCookieDate("ls",0),f.updateCookieDate("ts",0)};var k=window.navigator.sendBeacon,y="https:"===window.document.location.protocol?"https://":"http://";var w=document.body||null,D=document.documentElement||null,L=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.impNodeList=[],this.clientHeight=0,this.docScrollTop=0,this.docScrollHeight=0,this.bee=e}var e,i,n;return e=t,(i=[{key:"start",value:function(){this.getTargetList(w),this.scrollFunc()}},{key:"sendImp",value:function(e){this.bee.sendImp(e)}},{key:"scrollFunc",value:function(){var e=this,t=window.scrollY;if(e.getClientHeight(),e.getScrollTop(),e.getScrollHeight(),e.docScrollTop===t&&0<e.impNodeList.length){for(var i=[],n=0,o=e.impNodeList.length;n<o;n+=1){var r=e.impNodeList[n];if(parseInt(r.node.offsetHeight,10)<D.clientHeight){var a=window.screen.availWidth,s=r.node.getBoundingClientRect().top,c=r.node.getBoundingClientRect().right,u=r.node.getBoundingClientRect().bottom,d=r.node.getBoundingClientRect().left;s<=e.clientHeight&&0<s&&0<c&&c<=a||-s<r.node.offsetHeight&&s<0&&0<c&&c<=a?r.node.attributes[l.impTag]&&!r.flag&&(r.flag=!0,i.push(r.node)):s<=e.clientHeight&&0<s&&u<2*window.screen.availHeight&&d<=a&&r.node.attributes[l.impTag]&&!r.flag&&(r.flag=!0,i.push(r.node))}}0<i.length&&e.sendImp(i)}}},{key:"getTargetList",value:function(e){if(f.isDef(e.hasChildNodes))for(var t=e.childNodes,i=0,n=t.length;i<n;i+=1){var o=t.item(i);if(f.isDef(o.offsetTop)&&f.isDef(o.offsetHeight)){if(o.attributes[l.impTag]&&"none"!==o.style.display){var r=o.attributes[l.impTag].nodeValue;!this.isContains(r)&&r&&this.impNodeList.push({node:o,beeImp:r,flag:!1})}this.getTargetList(o)}}}},{key:"isContains",value:function(e){for(var t=this.impNodeList.length;0<t;){if(this.impNodeList[t-1].beeImp===e)return!0;--t}return!1}},{key:"getClientWidth",value:function(){var e=w.clientWidth,t=D.clientWidth;this.getClientWidth=e&&t?e<t?e:t:t<e?e:t}},{key:"getClientHeight",value:function(){var e=w.clientHeight,t=D.clientHeight;this.clientHeight=e&&t?e<t?e:t:t<e?e:t}},{key:"getScrollTop",value:function(){var e=0;D&&D.scrollTop?e=D.scrollTop:w&&(e=w.scrollTop),this.docScrollTop=e}},{key:"getScrollHeight",value:function(){this.docScrollHeight=Math.max(w.scrollHeight,D.scrollHeight)}}])&&o(e.prototype,i),n&&o(e,n),t}(),S=window,T=S.document;function H(e){return f.joinJson(l,e),l}function N(e,t){var i,n,o,r;function a(){clearTimeout(o),n.beeImp.start(),o=setTimeout(function(){a()},l.impInterval)}f.isDef(e)&&f.isString(e)&&(l.pid=e),f.isDef(t)&&f.isObject(t)&&H(t),this.beeData=new C,l.domain=f.getTopDomain(window.document.domain),this.isFirstVisit(),this.isNewSession(),l.autoPage&&this.sendPage(),f.addListener("click",(i=this).onClick.bind(i),!0),l.imp&&(o=null,(n=this).beeImp=new L(n),f.addListener("load",function(){a()},!0),f.addListener("scroll",a,!0),f.addListener("click",a,!0)),l.spa&&(r=this,f.customHistory("pushState"),f.customHistory("replaceState"),f.addListener("beeHistoryChange",r.onRouteChange.bind(r),!1),f.addListener("hashchange",r.onRouteChange.bind(r),!1))}var e;(e=N).prototype.send=function(e){var t=arguments.length<=1||void 0===arguments[1]||arguments[1],i=null;"undefined"!=typeof XMLHttpRequest?i=new XMLHttpRequest:"undefined"!=typeof ActiveXObject&&(i=new ActiveXObject("Microsoft.XMLHTTP")),i.open("POST",y+l.req,t),i.setRequestHeader("Content-Type","text/plain");var n=f.checkRCFL(e);p("埋点上报数据：","类型",n.t,"数据",n),i.send(JSON.stringify(n)),this.beeData.updateCookieDate()},e.prototype.sendBean=function(e){if(!f.isFunction(k))return this.send(e,!1);var t=f.checkRCFL(e);return navigator.sendBeacon(y+l.req,JSON.stringify(t))?(p("埋点上报数据(Beacon)：","类型",t.t,"数据",t),this.beeData.updateCookieDate()):this.send(e,!1),!0},N.prototype.isFirstVisit=function(){f.validUid(f.getCookie("uid"))||this.beeData.setUserData()},N.prototype.isNewSession=function(){f.isUndefined(f.getCookie("sid"))&&this.beeData.setSessionData()},N.prototype.setConfig=function(e){return f.isDef(e)&&(f.isObject(e)&&H(e),f.isString(e))?l[e]:l},N.prototype.onClick=function(e){var t=e.target,i=f.getAttribute(t,l.clickTag,!0);if(!i&&!~l.clickList.indexOf(t.tagName.toLocaleLowerCase()))return!1;if(f.isVoid(i)&&!l.allClick)return!1;var n=f.getElementInfo(t);return this.sendClick(n,i)},N.prototype.sendPage=function(){var e=this.beeData.makePageData();this.send(e)},N.prototype.sendClick=function(e,t){var i=this.beeData.makeClickData(e,t);this.sendBean(i)},N.prototype.sendImp=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];if(0!==e.length){var t=this.beeData.makeImpData(e);this.sendBean(t)}},N.prototype.sendCustom=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(f.isVoid(e)||!f.isString(e)||~["page","imp","clck"].indexOf(e))return g("自定义事件异常！"),!1;var i=this.beeData.makeCustomData(e,t);return this.sendBean(i),!0},N.prototype.onRouteChange=function(e){var t,i;i=e instanceof S.HashChangeEvent?(t=e.newURL,e.oldURL):(t=e.detail&&e.detail.newURL,e.detail&&e.detail.oldURL),this.beeData.updateRoute(t,i),this.sendPage()},N.prototype.command=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n={page:"sendPage",click:"sendClick",event:"sendCustom",imp:"sendImp",config:"setConfig"},o=!1;switch(e){case"page":var r=T.URL;f.isNotVoid(t)&&f.isString(t)&&(r=t),this.beeData.updateRoute(r),this.sendPage();break;case"imp":if(l.imp&&this.beeImp instanceof L)if(f.isVoid(t))this.beeImp.start();else{var a=f.isArray(t)?t:[t];this.sendImp(a)}break;default:f.hasOwn(n,e)&&(o=this[n[e]](t,i))}return o},function(){if(!window.bee.done){var o=null,e=window.bee&&window.bee.q?window.bee.q.slice():[];for(window.bee=function(e,t,i){var n=!1;if(o instanceof N)try{n=o.command(e,t,i)}catch(e){g("调用异常！")}else"init"===e?(o=new N(t,i),n=!0):g("请初始化！");return n},window.bee.done=!0,window.bee.toString=function(){return"Bee: bee() { [native code] }"};0<e.length;){var t,i=e.shift();(t=window).bee.apply(t,r(i))}}}()}();
